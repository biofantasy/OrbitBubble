<Window x:Class="OrbitBubble.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="OrbitBubble"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ShowInTaskbar="False"
        Topmost="True"
        ResizeMode="NoResize"
        WindowStartupLocation="Manual"

        Width="{Binding OverlaySize}"
        Height="{Binding OverlaySize}">

	<!-- Root overlay canvas: 外部拖曳（Explorer→App）接在這裡，空畫面也可 drop -->
	<Canvas x:Name="Root"
            Width="{Binding OverlaySize}"
            Height="{Binding OverlaySize}"
            AllowDrop="True"
            DragOver="Root_DragOver"
            Drop="Root_Drop">

		<!-- Ring -->
		<Ellipse Width="{Binding RingDiameter}"
                 Height="{Binding RingDiameter}"
                 Canvas.Left="{Binding RingLeft}"
                 Canvas.Top="{Binding RingTop}"
                 Stroke="#40FFFFFF"
                 StrokeThickness="2" />

		<!-- Hub (中心圈): 左鍵 Back、右鍵 Settings -->
		<Border Width="{Binding HubSize}"
                Height="{Binding HubSize}"
                Canvas.Left="{Binding HubLeft}"
                Canvas.Top="{Binding HubTop}"
                CornerRadius="{Binding HubCorner}"
                Background="#AA111111"
                BorderBrush="#66FFFFFF"
                BorderThickness="1"
                MouseLeftButtonUp="Hub_LeftClick"
                MouseRightButtonUp="Hub_RightClick">
			<Grid>
				<TextBlock Text="●"
                           Foreground="White"
                           FontSize="18"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
			</Grid>
		</Border>

		<!-- Bubbles layer -->
		<ItemsControl ItemsSource="{Binding VisibleBubbles}">
			<ItemsControl.ItemsPanel>
				<ItemsPanelTemplate>
					<Canvas/>
				</ItemsPanelTemplate>
			</ItemsControl.ItemsPanel>

			<ItemsControl.ItemContainerStyle>
				<Style TargetType="ContentPresenter">
					<Setter Property="Canvas.Left" Value="{Binding X}" />
					<Setter Property="Canvas.Top" Value="{Binding Y}" />
				</Style>
			</ItemsControl.ItemContainerStyle>

			<ItemsControl.ItemTemplate>
				<DataTemplate>
					<!-- 用 Button 才有 MouseDoubleClick，比 Border 穩 -->
					<Button Background="Transparent"
                            BorderThickness="0"
                            Padding="0"
                            Focusable="False"

                            MouseDoubleClick="Bubble_DoubleClick"
                            PreviewMouseLeftButtonDown="Bubble_PreviewMouseLeftButtonDown"
                            PreviewMouseMove="Bubble_PreviewMouseMove"

                            AllowDrop="True"
                            DragOver="Bubble_DragOver"
                            Drop="Bubble_Drop">

						<!-- 泡泡外觀 -->
						<Border Width="{Binding DataContext.BubbleSize, RelativeSource={RelativeSource AncestorType=Window}}"
                                Height="{Binding DataContext.BubbleSize, RelativeSource={RelativeSource AncestorType=Window}}"
                                CornerRadius="{Binding DataContext.BubbleCorner, RelativeSource={RelativeSource AncestorType=Window}}"
                                Background="#CC222222"
                                BorderBrush="#55FFFFFF"
                                BorderThickness="1">
							<Grid>
								<Image Source="{Binding Icon}"
                                       Width="28" Height="28"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>

								<TextBlock Text="{Binding DisplayName}"
                                           Margin="6,40,6,6"
                                           Foreground="White"
                                           FontSize="10"
                                           TextAlignment="Center"
                                           TextTrimming="CharacterEllipsis"/>
							</Grid>
						</Border>
					</Button>
				</DataTemplate>
			</ItemsControl.ItemTemplate>
		</ItemsControl>

		<!-- Debug：顯示泡泡數量（你確定跑穩再刪） -->
		<TextBlock Text="{Binding VisibleBubbles.Count}"
                   Foreground="Lime"
                   FontSize="14"
                   Canvas.Left="10"
                   Canvas.Top="10"/>
	</Canvas>
</Window>
